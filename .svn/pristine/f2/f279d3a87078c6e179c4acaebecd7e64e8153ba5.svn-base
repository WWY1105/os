var app = angular.module('app', ['ngRoute', 'ngMessages', 'ngAnimate', "ui.bootstrap"]);//创建APP

app.run(function ($rootScope, $location, $interval, $filter, $http) {//APP通用方法
    $rootScope.cache = {};
    $rootScope.config = {//设置
        time: new Date(),
    };
    $rootScope.goto = function (url) {	//转跳
        $location.path("/" + url);
        $rootScope.urlFn();
    }
})

app.directive('fileModel', ['$parse', function ($parse) {
    return {
        restrict: 'A',
        link: function (scope, element, attrs) {
            var model = $parse(attrs.fileModel);
            var modelSetter = model.assign;

            element.bind('change', function () {
                scope.$apply(function () {
                    modelSetter(scope.$parent, element[0].files[0]);
                });
            });
        }
    };
}]);

app.directive('backButton', function () {
    return {
        restrict: 'A',
        link: function (scope, element, attrs) {
            element.bind('click', goBack);
            function goBack() {
                history.back();
                scope.$apply();
            }
        }
    }
});

app.factory('messageFactory', ['$http', function ($http) {
    var msgFac = {};

    msgFac.query = function (cb) {
        $http.get(basic_url + '/message?' + sortUrl()).success(function (res) {
            cb(res);
        });
    }

    msgFac.add = function (msg, cb) {
        $http.post(basic_url + '/message?' + sortUrl(), msg).success(function (res) {
            cb(res);
        });
    }

    return msgFac;
}]);

app.factory('versionFactory', ['$http', function ($http) {
    var versionFac = {};

    versionFac.query = function (cb) {
        $http.get(basic_url + '/version?' + sortUrl()).success(function (res) {
            cb(res);
        });
    };

    versionFac.uploadFileToUrl = function (file, posts, cb) {
        var fd = new FormData();
        if (file) {
            fd.append('file', file);
        };
        $http.post(basic_url + '/file?' + sortUrl(),fd ,{
            transformRequest: angular.identity,
            headers: {'Content-Type': undefined}
        }).success(function (res) {
            posts.url = res.result.path;
            $http.post(basic_url + '/version?' + sortUrl(),posts
                )
                .success(function (res) {
                    cb(res);
                })
        })
    }

    versionFac.add = function (file, posts, cb) {
        this.uploadFileToUrl(file, posts, cb);
    };

    versionFac.del = function (id, cb) {
        $http.post(basic_url + '/version/' + id + "?" + sortUrl()).success(function (res) {
            cb(res);
        });
    }
    return versionFac;
}])

app.config(appRouteConfig);

function appRouteConfig($routeProvider) { //路由规则
    $routeProvider.when('/version', {
        templateUrl: "show.html",
        controller: "versionShowCtr"
    }).when('/version/add', {
        templateUrl: "add.html",
        controller: "versionAddCtr"
    }).when('/message', {
        templateUrl: "../message/show.html",
        controller: "messageShowCtr"
    }).when('/message/add', {
        templateUrl: "../message/add.html",
        controller: "messageAddCtr"
    });
};

app.controller('versionShowCtr', ['$scope', '$location', 'versionFactory', function ($scope, $location, versionFac) { //
    $scope.view = {
        product: {
            "A01": "上宾",
            "A02": "上宾管家"
        },
        platform: {
            "ios": "苹果",
            "android": "安卓",
            "winPhone": "微软"
        },
    };

    versionFac.query(function (res) {
        $scope.view.versions = res.result;
    });

    $scope.formatCtx = function (content) {
        return content.split(/\n/);
    }

    $scope.create = function () {
        $location.path("/version/add");
    }

    $scope.delete = function (id) {
        versionFac.del(id, function (res) {
            if (res.code == 200) {
                var arr = $scope.view.versions.items;
                for (var i = 0; arr && i < arr.length; i++) {
                    if (arr[i].id === id) {
                        arr.splice(i, 1);
                        break;
                    }
                    ;
                }
                ;
            } else {
                alert("删除失败");
            }
        })
    }

}]);

app.controller('versionAddCtr', ['$scope', '$location', 'versionFactory', function ($scope, $location, versionFac) { //
    $scope.view = {
        products: [
            {name: "上宾", key: "USER_APP"},
            {name: "上宾管家", key: "SHOP_APP"},
        ],

        platforms: [
            {name: "苹果", key: "IOS"},
            {name: "安卓", key: "ANDROID"},
            {name: "微软", key: "WINPHONE"},
        ],

        methods: [
            {id: '1', name: "应用市场"},
            {id: '2', name: "上宾官网"},
        ],
    };


    $scope.postSend = function () {
        versionFac.add($scope.myFile, $scope.posts, function function_name(res) {
            if (res.code !== 200) {
                alert("出错了");
            } else {
                $location.path("/version");
            }
        });
    }

}]);

app.controller('messageShowCtr', ['$scope', '$location', 'messageFactory', function ($scope, $location, msgFac) {

    $scope.view = {};

    msgFac.query(function (res) {
        $scope.view.messages = res.result;
    });

    $scope.create = function () {
        $location.path("/message/add");
    }
}]);

app.controller('messageAddCtr', ['$scope', '$location', 'messageFactory', function ($scope, $location, msgFac) {

    $scope.posts = {
        type: '0100',
    };
    $scope.postSend = function () {
        msgFac.add(angular.toJson($scope.posts), function (res) {
            if (res.code !== 200) {
                alert("出错了");
            } else {
                $location.path("/message");
            }
        });
    }
}]);
