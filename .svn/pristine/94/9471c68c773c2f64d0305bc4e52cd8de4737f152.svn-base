var app = angular.module('app', ['ngRoute', 'ngMessages', 'ngAnimate', "ui.bootstrap"]);//创建APP

app.run(function ($rootScope, $location, $interval, $filter, $http) {//APP通用方法
    $rootScope.cache = {};
    $rootScope.config = {//设置
        time: new Date(),
    };
    $rootScope.goto = function (url) {	//转跳
        $location.path("/" + url);
        $rootScope.urlFn();
    }
    $rootScope.jsonToUrl = function (para) {
        var json = objSort(para);
        var str = "";
        for (var i in json) {
            str += i + "=" + json[i] + "&";
        }
        str = str.substr(0, str.length - 1);
        return str;
    }
})

app.directive('fileModel', ['$parse', function ($parse) {
    return {
        restrict: 'A',
        link: function (scope, element, attrs) {
            var model = $parse(attrs.fileModel);
            var modelSetter = model.assign;

            element.bind('change', function () {
                scope.$apply(function () {
                    modelSetter(scope.$parent, element[0].files[0]);
                });
            });
        }
    };
}]);

app.directive('backButton', function () {
    return {
        restrict: 'A',
        link: function (scope, element, attrs) {
            element.bind('click', goBack);

            function goBack() {
                history.back();
                scope.$apply();
            }
        }
    }
});

app.factory('messageFactory', ['$http', function ($http) {
    var msgFac = {};

    msgFac.query = function (cb) {
        $http.get(basic_url + '/message?' + sortUrl()).success(function (res) {
            cb(res);
        });
    }

    msgFac.add = function (msg, cb) {
        $http.post(basic_url + '/message?' + sortUrl(), msg).success(function (res) {
            cb(res);
        });
    }

    msgFac.del = function (msg, cb) {
        $http.delete(basic_url + '/message/'+ msg +'?' + sortUrl() ).success(function (res) {
            cb(res);
        });
    }
    return msgFac;
}]);

app.factory('versionFactory', ['$http', function ($http) {
    var versionFac = {};

    versionFac.query = function (cb, str) {
        $http.get(basic_url + '/version?' + str).success(function (res) {
            cb(res);
        });
    };

    versionFac.uploadFileToUrl = function (file, posts, cb) {
        var fd = new FormData();
        if (file) {
            fd.append('file', file);
        }


        $http.post(basic_url + '/file?' + sortUrl(), fd, {
            transformRequest: angular.identity,
            headers: {'Content-Type': undefined}
        }).success(function (res) {
            if (res.code == 200) {
                posts.url = res.result.path;
                versionFac.version(posts, cb);
            } else {
                alert(res.message);
            }
        })
    };
    versionFac.version = function (posts, cb) {
        $http.post(basic_url + '/version?' + sortUrl(), posts).success(function (res) {
            cb(res);
        })
    };
    versionFac.add = function (file, posts, cb) {
        this.uploadFileToUrl(file, posts, cb);
    };

    versionFac.del = function (id, cb) {
        $http.delete(basic_url + '/version/' + id + "?" + sortUrl()).success(function (res) {
            cb(res);
        });
    }
    return versionFac;
}])

app.config(appRouteConfig);

function appRouteConfig($routeProvider) { //路由规则
    $routeProvider.when('/version', {
        templateUrl: "show.html",
        controller: "versionShowCtr"
    }).when('/version/add', {
        templateUrl: "add.html",
        controller: "versionAddCtr",
    }).when('/message', {
        templateUrl: "../message/show.html",
        controller: "messageShowCtr"
    }).when('/message/add', {
        templateUrl: "../message/add.html",
        controller: "messageAddCtr"
    }).when('/medialMessage/add', {
        templateUrl: "../medialMessage/add.html",
        controller: "medialMessageAddCtr"
    }).when('/medialMessage', {
        templateUrl: "../medialMessage/show.html",
        controller: "medialMessageShowCtr"
    }).when('/cashiers', {
        templateUrl: "show.html",
        controller: "cashiersShowCtr"
    }).when('/cashiers/add', {
        templateUrl: "add.html",
        controller: "cashiersAddCtr"
    }).when('/casher/:id', {
        templateUrl: "/admin/user/casher.html",
        controller: "userCasherCtr"
    }).when('/user/activity', {
        templateUrl: "/admin/user/activity.html",
        controller: "userActivityCtr"
    }).when('/placards', {
        templateUrl: "/admin/placards/index.html",
        controller: "adCtr"
    }).when('/placards/add', {
        templateUrl: "/admin/placards/add.html",
        controller: "adAddCtr"
    }).when('/placards/edit/:id', {
        templateUrl: "/admin/placards/add.html",
        controller: "adAddCtr"
    }).when('/city', {
        templateUrl: "/admin/city/index.html",
        controller: "cityCtr"
    }).when('/order/:id', {
        templateUrl: "../order/show.html",
        controller: "orderCtr"
    }).when('/order/update/:id/:shop/:category', {
        templateUrl: "../order/update.html",
        controller: "orderEditCtr"
    }).when('/deal', {
        templateUrl: "../deal/show.html",
        controller: "dealCtr"
    }).when('/allocate', {
        templateUrl: "../allocate/show.html",
        controller: "allocateCtr"
    }).when('/allocate/wallets', {
        templateUrl: "../allocate/wallets.html",
        controller: "allocateWalletsCtr"
    });
};

app.controller('versionShowCtr', ['$scope', '$location', 'versionFactory', '$http', function ($scope, $location, versionFac, $http) { //
    $scope.view = {
        product: {
            "A01": "上宾",
            "A02": "捷帐宝",
        },
        platform: {
            "ios": "苹果",
            "android": "安卓",
            "winPhone": "微软",
        },
        channels: {
            '1000': '上宾官方',
            '1001': '商米',
            '1002': '联迪',
            '1003': '盛付通',
            '1005': '拉卡拉',
            '1006': '汇付天下',
            '1007': '富友'
        }
    };
    $scope.post = {};
    versionFac.query(function (res) {
        $scope.view.versions = res.result;
    }, getUrl());

    $scope.formatCtx = function (content) {
        return content.split(/\n/);
    }

    $scope.create = function () {
        $location.path("/version/add");
    }

    $scope.delete = function (id) {
        versionFac.del(id, function (res) {
            if (res.code == 200) {
                var arr = $scope.view.versions.items;
                for (var i = 0; arr && i < arr.length; i++) {
                    if (arr[i].id === id) {
                        arr.splice(i, 1);
                        break;
                    }
                    ;
                }
                ;
            } else {
                alert("删除失败");
            }
        })
    }
    $scope.lowsestFn = function (id) {
        $http.post(basic_url + '/version/' + id + "/lowest?" + sortUrl()).success(function (res) {
            if (res.code == 200) {
                location.reload();
            } else {
                alert(res.message);
            }
        });
    }

    $scope.filterFn = function () {
        var json = {page: $scope.view.versions.page || 1, count: $scope.view.versions.count || 20};
        if ($scope.post.platform) {
            json.plateform = $scope.post.platform.toUpperCase();
        }
        if ($scope.post.channel) {
            json.channel = $scope.post.channel;
        }
        versionFac.query(function (res) {
            $scope.view.versions = res.result || {};
        }, getUrl(json));
    }

}]);

app.controller('versionAddCtr', ['$scope', '$location', 'versionFactory', function ($scope, $location, versionFac) { //
    $scope.view = {
        products: [
            {name: "上宾", key: "USER_APP"},
            {name: "捷账宝", key: "SHOP_APP"},
        ],

        platforms: [
            {name: "苹果", key: "IOS"},
            {name: "安卓", key: "ANDROID"},
            {name: "微软", key: "WINPHONE"},
        ],
        channels: [{
            name: '富友', key: '1007'
        },{
            name: '上宾官方', key: '1000'
        }, {
            name: '商米', key: '1001'
        }, {
            name: '联迪', key: '1002'
        }, {
            name: '盛付通', key: '1003'
        }, {
            name: '拉卡拉', key: '1005'
        }, {
            name: '汇付天下', key: '1006'
        }],
        methods: [
            {id: '1', name: "应用市场"},
            {id: '2', name: "上宾官网"},
        ],
    };


    $scope.postSend = function () {
        $scope.posts.name = $scope.name1 + "." + $scope.name2 + "." + $scope.name3 + ($scope.name4 ? ("." + $scope.name4) : '');
        if ($scope.view.downMethod == "2") {
            versionFac.add($scope.myFile, $scope.posts, function function_name(res) {
                if (res.code !== 200) {
                    alert("出错了");
                } else {
                    $location.path("/version");
                }
            });
        } else {
            versionFac.version($scope.posts, function function_name(res) {
                if (res.code !== 200) {
                    alert("出错了");
                } else {
                    $location.path("/version");
                }
            });
        }

    }

}]);

app.controller('messageShowCtr', ['$scope', '$location', 'messageFactory',  '$http',function ($scope, $location, msgFac, $http) {

    $scope.view = {};
    msgFac.query(function (res) {
        $scope.view.messages = res.result;
    });
    $scope.create = function () {
        $location.path("/message/add");
    }
    $scope.delete = function (index) {
        if (confirm("确定删除？")) {
            $http.delete(basic_url + '/message/' + index + "?" + sortUrl()).success(function (res) {
                if (res.code == 200) {
                    console.log(res);
                    msgFac.query(function (res) {
                        $scope.view.messages = res.result;
                    });
                } else {
                    alert("删除失败");
                }
            });
        }
    };
    $scope.pageChange = function () {
        var json = {page: $scope.view.messages.page, count: $scope.view.messages.count};
        $http.get(basic_url + '/message?' + $scope.jsonToUrl(json)).success(function (res) {
            if (res.result) {
                $scope.view.messages = res.result;
            }
        });
    };
}]);

app.controller('messageAddCtr', ['$scope', '$location', 'messageFactory', function ($scope, $location, msgFac) {

    $scope.posts = {
        type: '',
    };
    $scope.add_form = {};
    // $scope.textCheckJson = textCheckJson;
    // $scope.textCheckErrorJson = textCheckErrorJson;
    $scope.postSend = function () {
        if($scope.posts.title.length > 30 || $scope.posts.title.length < 5) {
            alert("标题长度应为5-30个字符");
            return;
        }
        if($scope.posts.content.length > 500 || $scope.posts.content.length < 10) {
            alert("内容长度应为10-500个字符");
            return;
        }
        msgFac.add(angular.toJson($scope.posts), function (res) {
            if (res.code !== 200) {
                alert("出错了");
            } else {
                $location.path("/message");
            }
        });
    }
    
}]);
app.controller('medialMessageShowCtr', ['$scope', '$location', '$http', function ($scope, $location, $http) {
    $scope.view = {
        type: {
            "100": "关注回复",
            "101": "免费领卡微信提醒-小图",
            "102": "免费领卡微信提醒-大图",
            "103": "首次关注有礼",
            "200": "消费",
            "300": "凑单",
            "400": "砍价",
            "500": " 霸王餐-有红包，可助力",
            "501": "仅助力",
            "502": "仅红包",
            "503": "自己查看",
            "600": "抽奖",
            "601": "抽奖邀请"
        }
    };
    $http.get(basic_url + '/medials?' + sortUrl()).success(function (res) {
        $scope.view.messages = res.result;
    });

    $scope.editFn = function (index) {
        if (!$scope.view.urls) {
            $http.get(basic_url + '/materials?' + sortUrl()).success(function (res) {
                if (res.result) {
                    $scope.view.urls = res.result;
                }
            });
        }
        if ("number" == typeof index) {
            $scope.post = $scope.view.messages.items[index];
        } else {
            $scope.post = {}
        }
        $("#dialog_edit").modal("show");
    }
    $scope.sendJsons = function () {
        var url, type = 'POST';
        if ($scope.post.id) {
            url = basic_url + '/medials/' + $scope.post.id + '?' + sortUrl();
            type = "PUT";
        } else {
            url = basic_url + '/medials?' + sortUrl();
        }
        $http({
            method: type,
            url: url,
            data: $scope.post
        }).success(function (res) {
            if (res.code == 200) {
                $("#dialog_edit").modal("hide");
                $http.get(basic_url + '/medials?' + sortUrl()).success(function (res) {
                    $scope.view.messages = res.result;
                });
            } else {
                alert(res.message);
            }
        });
    };
    $scope.deleteFn = function (id, index) {
        var result = confirm("确定要删除吗？");
        if (result) {
            $http.delete(basic_url + '/medials/' + id + "?" + sortUrl()).success(function (res) {
                if (res.code == 200) {
                    $scope.view.messages.items.splice(index, 1);
                } else {
                    alert(res.message);
                }
            });
        }
    }
    $scope.pageChange = function () {
        var json = {page: $scope.view.urls.page, count: $scope.view.urls.count};
        $http.get(basic_url + '/materials?' + $scope.jsonToUrl(json)).success(function (res) {
            if (res.result) {
                $scope.view.urls = res.result;
            }
        });
    };
}])
app.controller('cashiersShowCtr', ['$scope', '$location', '$http', function ($scope, $location, $http) { //
    $scope.view = {};
    $scope.post = {};
    $http.get(basic_url + '/cashiers?' + getUrl()).success(function (res) {
        $scope.view.cashiers = res.result || {};
    });
    $scope.pageChange = function () {
        var json = {page: $scope.view.cashiers.page, count: $scope.view.cashiers.count};
        $http.get(basic_url + '/cashiers?' + $scope.jsonToUrl(json)).success(function (res) {
            $scope.view.cashiers = res.result;
        });
    };
    $scope.switch = function (id, state) {
        $http.post(basic_url + '/cashiers/' + id + "/" + state + "?" + sortUrl(), {}).success(function (res) {
            if (res.code == 200) {
                alert("操作成功");
                $scope.pageChange();
            } else {
                alert(data.messages);
            }
        })

    }
    $scope.delete = function (index) {
        if (confirm("确定删除？")) {
            $http.delete(basic_url + '/cashiers/' + $scope.view.cashiers.items[index].id + "?" + sortUrl()).success(function (res) {
                if (res.code == 200) {
                    $scope.pageChange();
                } else {
                    alert("删除失败");
                }
            });
        }
    }

}]);
app.controller('cashiersAddCtr', ['$scope', '$location', '$http', function ($scope, $location, $http) { //
    $scope.view = {};
    $http.get(basic_url + '/cashiers/type?' + getUrl()).success(function (res) {
        $scope.view.type = res.result || {};
    });
    $scope.posts = {};
    $scope.postSend = function () {
        $http.post(basic_url + '/cashiers?' + sortUrl(), $scope.posts).success(function (res) {
            if (res.code == 200) {
                $location.path("/cashiers");
            } else {
                alert(data.messages);
            }
        })

    }

}]);
app.controller('userCasherCtr', ['$scope', '$location', '$http', '$routeParams', function ($scope, $location, $http, $routeParams) { //
    $scope.view = {
        state: {
            1001: "创建中",
            1002: "认证审核中",
            1003: "已认证",
            1004: "关闭审核",
            1005: "关闭"
        }
    };
    $scope.post = {};
    $scope.config.name = "客户管理";
    $scope.config.url = "/user/index.html";
    $http.get(basic_url + '/cashier/shop/' + $routeParams.id + '?' + getUrl()).success(function (res) {
        $scope.view.detail = res.result || {};
    });
    $http.get(basic_url + '/cashiers/type?' + getUrl()).success(function (res) {
        $scope.view.type = res.result || {};
    });
    
    $scope.selectFn = function () {
        if ($scope.post.cashierType) {
            $http.get(basic_url + '/cashier/' + $scope.post.cashierType + '?' + getUrl()).success(function (res) {
                $scope.view.shops = res.result || [];
            });
        } else {
            $scope.view.shops = [];
        }
    }
    $scope.sync = function () {  
        if ($scope.post.cashierType) {
            $http.get(basic_url + '/cashier/' + $scope.post.cashierType + '/sync' + '?' + getUrl()).success(function (res) {
                // $scope.view.shops = res.result || [];
                if(res.code == 200 ){
                    location.reload();
                }
            });
        }
    }
    $scope.unbind = function () {
        $http.delete(basic_url + '/cashier/'+$scope.view.detail.type +'/shop/'  + $routeParams.id + '?' + getUrl()).success(function (data) {
            if (data.code == 200) {
                alert("解绑成功！");
                location.reload();
            } else {
                alert(data.message);
            }
        });
    }
    $scope.bind = function (index) {
        var json = {
            cashierType: $scope.post.cashierType,
            cashierId: $scope.view.shops.items[index].cashierShopId
        }

        $http.post(basic_url + '/cashier/shop/' + $routeParams.id + '?' + getUrl(), json).success(function (data) {
            if (data.code == 200) {
                alert("绑定成功！");
                location.reload();
            } else {
                alert(data.message);
            }
        });
    }
    $scope.submitFn = function () {
        zonValue = $("[name='zone-select']").val();
        if (zonValue && view.latitude && view.longitude) {
            var json = {
                area: $("[name=area1]").val(),
                latitude: view.latitude,
                longitude: view.longitude,
                zone: zonValue,
                settlementType: $("[name=ONLINE]").val(),
                guestId: bData.guestId
            };
            if ($scope.post.cashierType && $scope.post.cashierId) {
                json.cashierType = $scope.post.cashierType;
                json.cashierId = $scope.post.cashierId;
            }
            if (bData.state == 1002) {
                re = ajax_send(json, "/shop/" + bData.id, "POST", 1);
                if (re.code == 200) {
                    alert("审核通过");
                    location.reload()
                }
            } else if (bData.state == 1003) {
                re = ajax_send(json, "/shop/" + bData.id, "PUT", 1);
                if (re.code == 200) {
                    alert("修改成功");
                    location.reload()
                }
            }
        } else {
            alert("商圈及地图必须选择");
            return;
        }
    }


    $scope.pageChange = function () {
        var json = {page: $scope.view.cashiers.page, count: $scope.view.cashiers.count};
        $http.get(basic_url + '/cashiers?' + $scope.jsonToUrl(json)).success(function (res) {
            $scope.view.cashiers = res.result;
        });
    };
    $scope.switch = function (id, state) {
        $http.post(basic_url + '/cashiers/' + id + "/" + state + "?" + sortUrl(), {}).success(function (res) {
            if (res.code == 200) {
                alert("操作成功");
                $scope.pageChange();
            } else {
                alert(data.messages);
            }
        })

    }
    $scope.delete = function (index) {
        if (confirm("确定删除？")) {
            $http.delete(basic_url + '/cashiers/' + $scope.view.cashiers.items[index].id + "?" + sortUrl()).success(function (res) {
                if (res.code == 200) {
                    $scope.pageChange();
                } else {
                    alert("删除失败");
                }
            });
        }
    }

}]);
app.controller('userActivityCtr', ['$scope', '$location', '$http', '$routeParams', function ($scope, $location, $http, $routeParams) { //
    $scope.config.name = "客户管理";
    $scope.config.url = "/user/index.html";
    $scope.view = {
        all: false,
        type:{}
            // '6001': '入会及升级',
            // '6002': '充值',
            // '6003': '积分兑换',
            // '6004': '送券',
            // '6005': '打折',
            // '6006': '特价',
            // '6007': '消费返券',
            // '6008': '消费积分',
            // '6009': '积分抵现',
            // '6011': '充值卡',
            // '6012': '抵扣',
            // '6013': '满赠',
            // '6014': '满减',
            // '6015': '套餐',
            // '6016': '代用币',
            // '6017': '充值免单',
            // '6020': '参与游戏获秒杀资格',
            // '6021': '参与游戏获免费资格',
            // '6030': '关注有礼',
            // '6031': '升级赠送',
            // '6040': '凑单',
            // '6041': '砍价',
            // '6050': '评赏',
            // '6051': '抽奖',
            // '6052': '打赏',
            // '6053': '商城',
            // '6054': '预定',
            // '6060': '排队',
            // '6061': '不定期权益',
            // '6032': '生日活动'
        
    }
    $scope.post = {};
        // '6001': false,
        // '6002': false,
        // '6003': false,
        // '6004': false,
        // '6005': false,
        // '6006': false,
        // '6007': false,
        // '6008': false,
        // '6009': false,
        // '6011': false,
        // '6012': false,
        // '6013': false,
        // '6014': false,
        // '6015': false,
        // '6016': false,
        // '6017': false,
        // '6020': false,
        // '6021': false,
        // '6030': false,
        // '6031': false,
        // '6040': false,
        // '6041': false,
        // '6050': false,
        // '6051': false,
        // '6052': false,
        // '6053': false,
        // '6054': false
    // $scope.name = []
    $http.get(basic_url + '/activities/guest/' + $routeParams.id + '?' + getUrl()).success(function (res) {
        if (res.code == 200) {
            console.log(res.result);
            for (var i in res.result) {
                // $scope.post[res.result[i]] = true; //获取拥有的权限
                $scope.post[res.result[i].code] = res.result[i].enabled
                $scope.view.type[res.result[i].code] = res.result[i].name
            }
        }
        console.log($scope.post);
        console.log($scope.view.type);
    });
    $scope.$watch('view.all', function (newVal, oldVal) {
        if (newVal !== oldVal) {
            if (newVal) {
                angular.forEach($scope.post, function (value, key) {
                    this[key] = true;
                }, $scope.post)
            } else {
                angular.forEach($scope.post, function (value, key) {
                    this[key] = false;
                }, $scope.post)
            }
        }
    });
    // 点击确定
    $scope.submitFn = function () {
        var json = [];
        for (var i in $scope.post) {
            if ($scope.post[i]) {
                json.push(i);
            }
        }
        $http.post(basic_url + '/activities/guest/' + $routeParams.id + '?' + getUrl(), json).success(function (data) {
            if (data.code == 200) {
                alert("绑定成功！");
            } else {
                alert(data.message);
            }
        });
    }
}]);
app.controller('adCtr', ['$scope', '$location', '$http', '$routeParams', function ($scope, $location, $http, $routeParams) { //
    $scope.config.name = "广告管理";
    $scope.config.url = "/user/index.html";
    $scope.view = {
        ads: {},
    }
    left_active = location.pathname.split("/");
    $("." + location.hash.split("/")[1] + "_index").addClass("active");
    $(".city_index").removeClass("active");
    $scope.post = {
        '6001': false,
        '6002': false,
        '6003': false,
        '6004': false,
        '6005': false,
        '6006': false,
        '6007': false,
        '6008': false,
        '6009': false,
        '6011': false,
        '6012': false,
        '6013': false,
        '6014': false,
        '6015': false,
        '6016': false,
        '6017': false,
        '6020': false,
        '6021': false,
        '6030': false,
        '6031': false,
        '6040': false,
        '6041': false,
        '6050': false,
        '6051': false,
        '6052': false,
        '6053': false,
        '6054': false
    };
    $http.get(basic_url + '/placards?' + getUrl()).success(function (res) {
        if (res.code == 200) {
            $scope.view.ads = res.result;
        }
    });
    $scope.create = function () {
        $location.path("/placards/add");
    }
    $scope.pageChange = function () {
        var json = {page: $scope.view.ads.page, count: $scope.view.ads.count};
        $http.get(basic_url + '/placards?' + $scope.jsonToUrl(json)).success(function (res) {
            if (res.result) {
                $scope.view.ads = res.result;
            }
        });
    };
    $scope.editFn = function (id) {
        $location.path("/placards/edit/" + id);
    }
    $scope.deleteFn = function (id, index) {
        var result = confirm("确定要删除吗？");
        if (result) {
            $http.delete(basic_url + '/placards/' + id + "?" + sortUrl()).success(function (res) {
                if (res.code == 200) {
                    $scope.view.ads.items.splice(index, 1);
                } else {
                    alert(res.message);
                }
            });
        }
    }
}]);
app.controller('adAddCtr', ['$scope', '$location', '$http', '$routeParams', function ($scope, $location, $http, $routeParams) { //
    $scope.config.name = "广告管理";
    $scope.config.url = "/user/index.html";
    $scope.view = {
        all: false
    }
    $scope.post = {};
    if ($routeParams.id) {
        $http.get(basic_url + '/placards/' + $routeParams.id + '?' + sortUrl()).success(function (res) {
            if (res.code == 200) {
                $scope.post = res.result;
            }
        });
    }
    $http.get(basic_url + '/materials?' + sortUrl()).success(function (res) {
        if (res.result) {
            $scope.view.urls = res.result;
        }
    });
    $scope.pageChange = function () {
        var json = {page: $scope.view.urls.page, count: $scope.view.urls.count};
        $http.get(basic_url + '/materials?' + $scope.jsonToUrl(json)).success(function (res) {
            if (res.result) {
                $scope.view.urls = res.result;
            }
        });
    };
    $scope.openFn = function (type) {
        $scope.view.type = type;
        $scope.view.picUrl = "";
        $scope.view.urls.page = 1;
        $scope.pageChange();
        $("#pic").modal("show");
    }
    $scope.sendPicFn = function () {
        $scope.post[$scope.view.type] = $scope.view.picUrl;
        $("#pic").modal("hide");
    }
    $scope.submitFn = function () {
        if (!$scope.post.transversePicUrl) {
            alert("请先选择图片");
            return;
        }
        if ($routeParams.id) {
            $http.put(basic_url + '/placards/' + $routeParams.id + '?' + getUrl(), $scope.post).success(function (data) {
                if (data.code == 200) {
                    alert("操作成功！");
                    $location.path("/placards");
                } else {
                    alert(data.message);
                }
            });
        } else {
            $http.post(basic_url + '/placards?' + getUrl(), $scope.post).success(function (data) {
                if (data.code == 200) {
                    alert("操作成功！");
                    $location.path("/placards");
                } else {
                    alert(data.message);
                }
            });
        }
    }
}]);
app.controller('cityCtr', ['$scope', '$location', '$http', '$routeParams', function ($scope, $location, $http, $routeParams) { //
    $scope.config.name = "城市广告管理";
    $scope.config.url = "/user/index.html";
    $scope.view = {
        ad: new Array(5),
        index: 0
    };
    $scope.post = {};
    left_active = location.pathname.split("/");
    $("." + location.hash.split("/")[1] + "_index").addClass("active");
    $(".placards_index").removeClass("active");

    $http.get(basic_url + '/area/city/opened?' + sortUrl()).success(function (res) {
        if (res.result) {
            $scope.view.city = res.result;
            $scope.chooseFn(0);

        }
    });
    $http.get(basic_url + '/placards?' + sortUrl()).success(function (res) {
        if (res.result) {
            $scope.view.placards = res.result;
        }
    });
    $scope.pageChange = function () {
        var json = {page: $scope.view.placards.page, count: $scope.view.placards.count};
        $http.get(basic_url + '/placards?' + $scope.jsonToUrl(json)).success(function (res) {
            if (res.result) {
                $scope.view.placards = res.result;
            }
        });
    };
    $scope.chooseFn = function (index) {
        $scope.view.index = index;//哪个城市
        $http.get(basic_url + '/placards/city/' + $scope.view.city[index].code + '/front?' + sortUrl()).success(function (res) {
            if (res.code == 200) {
                $scope.view.ad = new Array(5);
                for (var i in res.result) {
                    $scope.view.ad[res.result[i].place - 1] = res.result[i];
                }
            } else {
                $scope.view.ad = new Array(5);
            }
        });
    }
    $scope.openFn = function (index) {
        $scope.post.place = index + 1;//第几条
        $("#dialog").modal("show");
    }
    $scope.deleteFn = function (index) {
        var result = confirm("确认删除？删除后不可恢复哟");
        if (!result) return;
        $scope.post.place = index + 1;//第几条
        $scope.post.adsId = '';
        $http.delete(basic_url + '/placards/front/' + $scope.view.ad[index].id + '?' + getUrl()).success(function (data) {
            if (data.code == 200) {
                $scope.view.ad[index] = "";
            } else {
                alert(data.message);
            }
        });
    }
    $scope.submitFn = function () {
        $http.post(basic_url + '/placards/city/' + $scope.view.city[$scope.view.index].code + '/front?' + getUrl(), $scope.post).success(function (data) {
            if (data.code == 200) {
                $http.get(basic_url + '/placards/city/' + $scope.view.city[$scope.view.index].code + '/front?' + sortUrl()).success(function (res) {
                    if (res.code == 200) {
                        $scope.chooseFn($scope.view.index);
                        $("#dialog").modal("hide");

                    } else {
                        $scope.view.ad = new Array(5);
                    }
                });
            } else {
                alert(data.message);
            }
        });

    }
}]);

app.controller('dealCtr', ['$scope', '$location', 'messageFactory','$http','$filter',function ($scope, $location, msgFac, $http, $filter) {

    $scope.view = {};
    $scope.posts = { };
    $scope.initTimeFn = function () {
        var date = new Date();
        date.setHours(23);
        date.setMinutes(59);
        date.setSeconds(59);
        $scope.posts.endTime = date;
        var date1 = new Date();
        date1.setHours(0);
        date1.setMinutes(0);
        date1.setSeconds(0);
        date1.setDate(date.getDate() - 7);
        $scope.posts.startTime = date1;
        $scope.view.initTime = ($filter('date')(new Date(), "yyyy-MM-dd") + "T59:59");
    };
    $scope.initTimeFn();
    $scope.searchFn = function (id) {
        if (id) $scope.posts.selector = id;
        if (($scope.posts.endTime - $scope.posts.startTime) / (1000 * 60 * 60 * 24) > 31) {
            alert("起止时间不能超过31天");
            return;
        }
        $('#loadingDiv').show();
        var param = {};
        param.startTime = $filter('date')($scope.posts.startTime, "yyyy-MM-dd HH:mm:ss");
        param.endTime = $filter('date')($scope.posts.endTime, "yyyy-MM-dd HH:mm:ss");
        $http.get(basic_url + '/finance?' + getUrl(param)).success(function (res) {
            if (res.code == 200) {
                $scope.view.messages = res.result;
                $('#loadingDiv').hide();
            } else {
                $('#loadingDiv').hide();
            }
        });
    };
    $scope.searchFn();
    $scope.pageChange = function () {
        if (($scope.posts.endTime - $scope.posts.startTime) / (1000 * 60 * 60 * 24) > 31) {
            alert("起止时间不能超过31天");
            return;
        }
        $('#loadingDiv').show();
        $('tbody').hide();
        var param = {};
        param.startTime = $filter('date')($scope.posts.startTime, "yyyy-MM-dd HH:mm:ss");
        param.endTime = $filter('date')($scope.posts.endTime, "yyyy-MM-dd HH:mm:ss");
        param.page = $scope.view.messages.page;
        param.count = $scope.view.messages.count;
        $http.get(basic_url + '/finance?' + $scope.jsonToUrl(param)).success(function (res) {
            if (res.code == 200) {
                $scope.view.messages = res.result;
                $('#loadingDiv').hide();
                $('tbody').show();
            } else{
                console.log(1111);
                $('#loadingDiv').hide();
            }
        });
    };
    
    $scope.delete = function (index) {
        if (confirm("确定删除？")) {
            $http.delete(basic_url + '/message/' + index + "?" + sortUrl()).success(function (res) {
                if (res.code == 200) {
                    console.log(res);
                    msgFac.query(function (res) {
                        $scope.view.messages = res.result;
                    });
                } else {
                    alert("删除失败");
                }
            });
        }
    }
}]);

app.controller('allocateCtr', ['$scope', '$location', 'messageFactory','$http','$filter',function ($scope, $location, msgFac, $http, $filter) {

    $scope.view = {};
    $scope.type = '';
    $scope.posts = {};
    $scope.edit = {};
    $http.get(basic_url + '/profits/extracts?' + sortUrl()).success(function (res) {
        if (res.code == 200) {
            $scope.posts.messages = res.result;
        } 
    });
    $scope.change = function (type) { 
        $scope.type = type ; 
        if(type == '601') { //充值
            $http.get(basic_url + '/profits/extracts?' + sortUrl()).success(function (res) {
                if (res.code == 200) {
                    $scope.posts.messages = res.result;
                } 
            });
        }
    };
    $scope.initTimeFn = function () {
        var date = new Date();
        date.setHours(23);
        date.setMinutes(59);
        date.setSeconds(59);
        $scope.posts.endTime = date;
        var date1 = new Date();
        date1.setHours(0);
        date1.setMinutes(0);
        date1.setSeconds(0);
        date1.setDate(date.getDate() - 7);
        $scope.posts.startTime = date1;
        $scope.posts.initTime = ($filter('date')(new Date(), "yyyy-MM-dd") + "T59:59");;
    };
    $scope.initTimeFn();
    $scope.searchFn = function (id) {
        if (($scope.posts.endTime - $scope.posts.startTime) / (1000 * 60 * 60 * 24) > 31) {
            alert("起止时间不能超过31天");
            return;
        }
        var param = {};
        param.startTime = $filter('date')($scope.posts.startTime, "yyyy-MM-dd HH:mm:ss");
        param.endTime = $filter('date')($scope.posts.endTime, "yyyy-MM-dd HH:mm:ss");

        $http.get(basic_url + '/profits/extracts?' + $scope.jsonToUrl(param)).success(function (res) {
            if (res.code == 200) {
                $scope.posts.messages = res.result;
            } 
        });
    };
    $scope.pageChange = function () {
        if( $scope.type == '601') {
            var json = {page: $scope.posts.messages.page, count: $scope.posts.messages.count};
            $http.get(basic_url + '/profits/extracts?' + $scope.jsonToUrl(json)).success(function (res) {
                if (res.result) {
                    $scope.posts.messages = res.result;
                }
            });
        }
    };
    $scope.audit = function (index) {
        $("#edit").modal("show");
        $http.get(basic_url + '/profits/extracts/' + index + "?" + sortUrl()).success(function (res) {
            if (res.code == 200) {
                $scope.edit.message = res.result;
            } else {
                alert(res.message);
            }
        });
        $http.get(basic_url + '/wallets?' + sortUrl()).success(function (res) {
            $scope.edit.wallets = res.result;
        });

    };
    $scope.affirm = function (index,state) {
        if(state == 1004) {
            if(!($('#wallet_des').val())) {
                alert('请填写驳回备注');
                return false;
            }
        }
        if($('#wallet_des').val().length > 50) {
            alert('备注长度为50字以内');
            return false;
        }
        $http.post(basic_url + '/profits/wallet/' + index + "?" + getUrl() , {"state" : state , "description" : $('#wallet_des').val()}).success(function (res) {
            if (res.code == 200) {
                $scope.edit.message.wallet.state = '1111';
            } else {
                alert(res.message);
            }
        })
    };
    $("input[type=file]").change(function () {
        var objUrl = getObjectURL(this.files[0]);
        if (objUrl) {
            imgShow = $(this).parent().parent().find("img");
            imgShow.attr("src", objUrl);
            imgShow.width("100%");
        }
    });
    $scope.create = function () {
        $location.path("/allocate/wallets");
    }
    function pic_check(pic) {
        obj = $("." + pic + "Chose");
        input = $("." + pic + " input");
        if (!input.val() || input.val() !== "") {
            obj.text("已选择").addClass('btn-success').removeClass("btn-primary").removeClass("btn-error");

        } else {
            obj.text("请选择图片").addClass('btn-error').removeClass("btn-primary").removeClass("btn-success");
        }
    }
    $('form').submit(function () {  
        if (!($("#file").val())) {
            alert("请先选择凭证图片");
            return false;
        }
        if($scope.view.description && $scope.view.amount && $scope.view.fee&& $scope.view.walletOutId ) {

            POSTurl = basic_url + "/pics?" + sortUrl();
            options = {
                url: POSTurl,
                type: "POST",
                success: function (data) {
                    if (data.code == 200) {
                        if($scope.edit.message.wallet.state == 1111) {
                            $scope.view.voucher = data.result.url; 
                            $scope.view.extractId = $scope.edit.message.id; 
                            console.log($scope.view);
                            $http.post(basic_url + '/profits/transfer?' + sortUrl(), $scope.view).success(function (res) {
                                if(res.code == 200) {
                                    // window.onload();
                                    // $location.path("/allocate/index.html#/allocate");
                                    location.reload();

                                }else {
                                    alert(res.message);
                                }
                            });
                        }else {
                            alert('请先确认申请信息');
                            return false;
                        }
                       
                    } else { 
                        alert(data.message);
                    }
                }
            };
            $(this).ajaxSubmit(options);
            return false;
        }else{
            alert('请将信息填写完整');
            return false;
        }
        
    });


}]);

app.controller('allocateWalletsCtr', ['$scope', '$location', 'messageFactory','$http','$filter',function ($scope, $location, msgFac, $http, $filter) {

    $scope.view = {};
    $scope.posts = {};
    $scope.addW = function () {  
        $("#add").modal("show");
    }
    $http.get(basic_url + '/wallets?' + sortUrl()).success(function (res) {
        $scope.view.messages = res.result;
    });
    $scope.audit = function (index) {
        $("#edit").modal("show");
        $http.get(basic_url  + '/wallets/' + index + "?" +  sortUrl()).success(function (res) {
            $scope.posts = res.result;
        });
    };
    $scope.delete = function (index) {
        if (confirm("确定删除？")) {
            $http.delete(basic_url + '/wallets/' + index + "?" + sortUrl()).success(function (res) {
                if (res.code == 200) {
                    console.log(res);
                    $http.get(basic_url + '/wallets?' + sortUrl()).success(function (res) {
                        $scope.view.messages = res.result;
                    });
                } else {
                    alert("删除失败");
                }
            });
        }
    };
    function checkCard(cardNo){
          if(isNaN(cardNo)) return false;
            if(cardNo.length < 12){
                return false;
            }
            var nums = cardNo.split("");
            var sum = 0;
            var index = 1;
            for(var i = 0 ; i < nums.length; i++){
                if((i+1)%2==0){
                    var tmp = Number(nums[nums.length-index])*2;
                    if(tmp >= 10){
                        var t = tmp+"".split("");
                        tmp = Number(t[0]) + Number(t[1]);
                    }
                    sum+=tmp;
                }else{
                    sum+=Number(nums[nums.length-index]);
                }
                index ++;
            }
            if(sum%10 != 0){
                return false;
            }
            return true;
    };
    $('#add form').submit(function () {
        /*text_check = new text_check_new();
        if (!text_check.pic_check()) {
        return false
        }*/
        if (!($("#identityPic").val())) {
            alert("请先选择图片");
            return false;
        }
        if (!($("#cardPic").val())) {
            alert("请先选择图片");
            return false;
        }
        if(!(/^1[3456789]\d{9}$/.test($scope.posts.phone))){
            alert("手机号码有误，请重填");  
            return false; 
        }
        var reg = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;  
        if(reg.test($scope.posts.identityNo) === false) {  
            alert("身份证输入不合法");  
            return  false;  
        } 
        if( !checkCard($scope.posts.cardNo) ) {
            alert('银行卡输入错误,请核对后请重新提交');
            return false;
        }
        POSTurl = basic_url + "/wallets/pic?" + sortUrl();
        options = {
            url: POSTurl,
            type: "POST",
            success: function (data) {
                if (data.code == 200) {
                    $scope.posts.cardPicUrl = data.result.cardPicUrl;
                    $scope.posts.identityPicUrl = data.result.identityPicUrl;
                    $http.post(basic_url + '/wallets?' + sortUrl(), $scope.posts).success(function (res) {
                        console.log(res);
                        if(res.code == 200) {
                            $(".add").modal("hide");
                            alert("操作成功");
                            location.reload();
                        }else{
                            alert(res.message);
                        }
                        // $(this).resetForm();
                    });
                } else { 
                    alert(data.message);
                }
            }
        };
        $(this).ajaxSubmit(options);
        return false;
    });
    $('#edit form').submit(function () {
        if(!(/^1[3456789]\d{9}$/.test($scope.posts.phone))){
            alert("手机号码有误，请重填");  
            return false; 
        }
        var reg = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;  
        if(reg.test($scope.posts.identityNo) === false) {  
            alert("身份证输入不合法");  
            return  false;  
        };  
        if( !checkCard($scope.posts.cardNo) ) {
            alert('银行卡输入错误,请核对后请重新提交');
            return false;
        }
        if($('.cardPicChose').text() == "已选择"){
            POSTurl = basic_url + "/wallets/pic?" + sortUrl();
            options = {
                url: POSTurl,
                type: "POST",
                success: function (data) {
                    if (data.code == 200) {
                        if($('.identityPicChose').text() == "已选择") {
                            $scope.posts.cardPicUrl = data.result.cardPicUrl;
                            $scope.posts.identityPicUrl = data.result.identityPicUrl;
                        }else {
                            $scope.posts.cardPicUrl = data.result.cardPicUrl;
                        }
                        $http.post(basic_url + '/wallets?' + sortUrl(), $scope.posts).success(function (res) {
                            console.log(res);
                            $(".add").modal("hide");
                            alert("操作成功");
                            location.reload();
                        });
                    } else { 
                        alert(data.message);
                    }
                }
            }
            $(this).ajaxSubmit(options);
            return false;
        }else {
            POSTurl = basic_url + "/wallets/pic?" + sortUrl();
            options = {
                url: POSTurl,
                type: "POST",
                success: function (data) {
                    if (data.code == 200) {
                        if($('.identityPicChose').text() == "已选择") {
                            $scope.posts.identityPicUrl = data.result.identityPicUrl;
                        }
                        $http.post(basic_url + '/wallets?' + sortUrl(), $scope.posts).success(function (res) {
                            console.log(res);
                            $(".add").modal("hide");
                            alert("操作成功");
                            location.reload();
                        });
                    } else { 
                        alert(data.message);
                    }
                }
            }
            $(this).ajaxSubmit(options);
            return false;
        }
    });

}]);

app.controller('orderCtr', ['$scope', '$location', 'messageFactory','$http','$filter','$routeParams',function ($scope, $location, msgFac, $http, $filter,$routeParams,) {
    $scope.view = {};
    $scope.posts = {};
    // $scope.posts.shopId = $routeParams.id;
    $scope.initTimeFn = function () {
        var date1 = new Date();
        date1.setHours(0);
        date1.setMinutes(0);
        date1.setSeconds(0);
        // $scope.posts.date = date1.toLocaleDateString();
        $scope.posts.date = date1;
        $scope.posts.initTime = $filter('date')(new Date(), "yyyy-MM-dd");
    };
    $http.get(basic_url + '/balance/guest/'+$routeParams.id+'/shops?' + sortUrl()).success(function (res) {
        if (res.code == 200) {
            $scope.posts.shops = res.result;
        } 
    });
    $scope.initTimeFn();
    $scope.searchFn = function () { 
        if (($scope.posts.date - $scope.posts.initTime) / (1000 * 60 * 60 * 24) > 1) {
            alert("时间不能超过今天");
            return;
        }
        var param = {};
        param.date = $filter('date')($scope.posts.date, "yyyy-MM-dd HH:mm:ss");
        param.category = $scope.posts.category;
        param.amount = $scope.posts.amount;
        if(param.date&&param.category&&param.amount&&$scope.posts.guestId) {
            // $http.get(basic_url + '/balance/shop/' + $routeParams.id + '?' + getUrl(), param).success(function (res) {
            $http.get(basic_url + '/balance/shop/'+ $scope.posts.guestId +'?' + $scope.jsonToUrl(param)).success(function (res) {
                if (res.code == 200) {
                    $scope.posts.messages = res.result;
                }else {
                    $scope.posts.messages = ""
                }
            });
        }else {
            alert('请填写完整信息');
            return
        }
    };
    $scope.create = function (id) {
        var category = $scope.posts.category ;
        // $location.path("/order/update/"+ id+"/"+ $routeParams.id+"/"+ category);
        $location.path("/order/update/"+ id+"/"+ $routeParams.id+"/"+ category);
    }
}]);

app.controller('orderEditCtr', ['$scope', '$location','$http','$filter','$routeParams',function ($scope, $location, $http, $filter,$routeParams,) {
    $scope.view = {};
    $scope.posts = {};
    $scope.initTimeFn = function () {
        var date1 = new Date();
        date1.setHours(0);
        date1.setMinutes(0);
        date1.setSeconds(0);
        $scope.posts.tradeTime = date1;
        $scope.posts.initTime = ($filter('date')(new Date(), "yyyy-MM-dd") + "T59:59");;
    };
    $http.get(basic_url + '/balance/shop/'+$routeParams.shop+'/order/'+ $routeParams.id + '/'+$routeParams.category+'?' + sortUrl()).success(function (res) {
        if (res.code == 200) {
            $scope.posts.message = res.result;
        } 
    });
    $scope.initTimeFn();
    $scope.send = function () {
        var param = {} ;
        param.payMode = $scope.posts.payMode;
        param.tradeTime = $filter('date')($scope.posts.tradeTime, "yyyy-MM-dd HH:mm:ss");
        if($scope.posts.payMode == '1000'&&$scope.posts.referenceNo&&$scope.posts.traceNo ) { //刷卡
            param.referenceNo = $scope.posts.referenceNo;
            param.traceNo = $scope.posts.traceNo;
        }else if($scope.posts.payMode != '1000'&&$scope.posts.tradeNo&&$scope.posts.tansNo&&$scope.posts.channelNo ){
            param.tradeNo = $scope.posts.tradeNo;
            param.tansNo = $scope.posts.tansNo;
            param.channelNo = $scope.posts.channelNo;
        }else {
            alert('请填写完整信息');
            return;
        }
        $http.post(basic_url + '/balance/shop/'+ $routeParams.shop +'/order/'+ $routeParams.id +'/'+$routeParams.category+'?'+ sortUrl(), param ).success(function (res) {
            if (res.code == 200) {
                alert('提交成功');
                $location.path("/order/"+ $routeParams.shop);
            }else {
                alert(res.message);
            }
        });
        console.log(param);
    }
}]);
